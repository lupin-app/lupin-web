{"version":3,"file":"frustration-plugin.js","sourceRoot":"","sources":["../../src/frustration-plugin.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable no-restricted-globals */\nimport {\n  BrowserClient,\n  BrowserConfig,\n  EnrichmentPlugin,\n  FrustrationInteractionsOptions,\n  DEFAULT_DATA_ATTRIBUTE_PREFIX,\n  multicast,\n  Observable,\n  Unsubscribable,\n  DEFAULT_RAGE_CLICK_ALLOWLIST,\n  DEFAULT_DEAD_CLICK_ALLOWLIST,\n  DEFAULT_ERROR_CLICK_ALLOWLIST,\n} from '@amplitude/analytics-core';\nimport * as constants from './constants';\nimport { createShouldTrackEvent, ElementBasedTimestampedEvent, NavigateEvent, TimestampedEvent } from './helpers';\nimport { trackDeadClick } from './autocapture/track-dead-click';\nimport { trackRageClicks } from './autocapture/track-rage-click';\nimport { ObservablesEnum } from './autocapture-plugin';\nimport {\n  BrowserErrorEvent,\n  createClickObservable,\n  createErrorObservable,\n  createMutationObservable,\n} from './observables';\nimport { DataExtractor } from './data-extractor';\nimport { trackErrorClicks } from './autocapture/track-error-click';\n\nexport interface AllWindowObservables {\n  [ObservablesEnum.ClickObservable]: Observable<ElementBasedTimestampedEvent<MouseEvent>>;\n  [ObservablesEnum.MutationObservable]: Observable<TimestampedEvent<MutationRecord[]>>;\n  [ObservablesEnum.BrowserErrorObservable]: Observable<TimestampedEvent<BrowserErrorEvent>>;\n  [ObservablesEnum.NavigateObservable]?: Observable<TimestampedEvent<NavigateEvent>>;\n  [ObservablesEnum.SelectionObservable]?: Observable<void>;\n}\n\ntype BrowserEnrichmentPlugin = EnrichmentPlugin<BrowserClient, BrowserConfig>;\n\n/**\n * Helper function to extract the css selector allowlist\n * from the frustration interactions options for a specific\n * autocapture feature.\n */\nfunction getCssSelectorAllowlist(\n  options: FrustrationInteractionsOptions,\n  attribute: keyof FrustrationInteractionsOptions,\n  defaultAllowlist: string[],\n  enabled: boolean,\n): string[] {\n  if (!enabled) {\n    return [];\n  }\n  const config = options[attribute];\n  if (\n    typeof config === 'object' &&\n    config !== null &&\n    'cssSelectorAllowlist' in config &&\n    Array.isArray(config.cssSelectorAllowlist)\n  ) {\n    return config.cssSelectorAllowlist;\n  }\n  return defaultAllowlist;\n}\n\nexport const frustrationPlugin = (options: FrustrationInteractionsOptions = {}): BrowserEnrichmentPlugin => {\n  const name = constants.FRUSTRATION_PLUGIN_NAME;\n  const type = 'enrichment';\n\n  const subscriptions: Unsubscribable[] = [];\n\n  let isErrorClicksEnabled = options.errorClicks !== false;\n\n  // if errorClicks is not defined, disable it\n  // change this once it moves out of @experimental\n  if (!options.errorClicks) {\n    isErrorClicksEnabled = false;\n  }\n\n  // Check if each feature is enabled\n  const deadClicksEnabled = options.deadClicks !== false && options.deadClicks !== null;\n  const rageClicksEnabled = options.rageClicks !== false && options.rageClicks !== null;\n\n  // Get CSS selectors for enabled features\n  const rageCssSelectors = getCssSelectorAllowlist(\n    options,\n    'rageClicks',\n    DEFAULT_RAGE_CLICK_ALLOWLIST,\n    rageClicksEnabled,\n  );\n  const deadCssSelectors = getCssSelectorAllowlist(\n    options,\n    'deadClicks',\n    DEFAULT_DEAD_CLICK_ALLOWLIST,\n    deadClicksEnabled,\n  );\n\n  const errorCssSelectors = getCssSelectorAllowlist(\n    options,\n    'errorClicks',\n    DEFAULT_ERROR_CLICK_ALLOWLIST,\n    isErrorClicksEnabled,\n  );\n\n  const dataAttributePrefix = options.dataAttributePrefix ?? DEFAULT_DATA_ATTRIBUTE_PREFIX;\n\n  const dataExtractor = new DataExtractor(options);\n\n  // combine the selector lists from enabled features to determine which clicked elements should be filtered\n  const combinedCssSelectors = [...new Set([...rageCssSelectors, ...deadCssSelectors, ...errorCssSelectors])];\n\n  // Create observables on events on the window\n  const createObservables = (): AllWindowObservables => {\n    const clickObservable = multicast(\n      createClickObservable('pointerdown').map((click) => {\n        return dataExtractor.addAdditionalEventProperties(\n          click,\n          'click',\n          combinedCssSelectors,\n          dataAttributePrefix,\n          true, // capture when cursor is pointer\n        );\n      }),\n    );\n\n    const browserErrorObservables = multicast(\n      createErrorObservable().map((error) => {\n        return dataExtractor.addTypeAndTimestamp(error, 'error');\n      }),\n    );\n\n    const enrichedMutationObservable = multicast<TimestampedEvent<MutationRecord[]>>(\n      createMutationObservable().map((mutation) =>\n        dataExtractor.addAdditionalEventProperties(mutation, 'mutation', combinedCssSelectors, dataAttributePrefix),\n      ),\n    );\n\n    let enrichedNavigateObservable: Observable<TimestampedEvent<NavigateEvent>> | undefined;\n\n    if (window.navigation) {\n      const navigateObservable = new Observable<Event>((observer) => {\n        const handler = (event: Event): void => {\n          observer.next({\n            ...event,\n            type: 'navigate',\n          });\n        };\n        window.navigation.addEventListener('navigate', handler);\n        return () => {\n          window.navigation.removeEventListener('navigate', handler);\n        };\n      });\n      enrichedNavigateObservable = multicast<TimestampedEvent<NavigateEvent>>(\n        navigateObservable.map<TimestampedEvent<NavigateEvent>>(\n          (navigate) =>\n            dataExtractor.addAdditionalEventProperties(\n              navigate,\n              'navigate',\n              combinedCssSelectors,\n              dataAttributePrefix,\n            ) as TimestampedEvent<NavigateEvent>,\n        ),\n      );\n    }\n\n    const selectionObservable = multicast(\n      new Observable<void>((observer) => {\n        const handler = () => {\n          const el: HTMLElement | null = document.activeElement as HTMLElement;\n\n          // handle input and textarea\n\n          // if the selectionStart and selectionEnd are the same, it means\n          // nothing is selected (collapsed) and the cursor position is one point\n          if (el && (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT')) {\n            let start: number | null | undefined;\n            let end: number | null | undefined;\n            try {\n              start = (el as HTMLInputElement | HTMLTextAreaElement).selectionStart;\n              end = (el as HTMLInputElement | HTMLTextAreaElement).selectionEnd;\n              if (start === end) return; // collapsed\n            } catch (error) {\n              // input that doesn't support selectionStart/selectionEnd (like checkbox)\n              // do nothing here\n              return;\n            }\n            return observer.next();\n          }\n\n          // handle non-input elements\n\n          // non-input elements have an attribute called \"isCollapsed\" which\n          // if true, indicates there \"is currently not any text selected\"\n          // (see https://developer.mozilla.org/en-US/docs/Web/API/Selection/isCollapsed)\n          const selection = window.getSelection();\n          if (!selection || selection.isCollapsed) return;\n          return observer.next();\n        };\n        window.document.addEventListener('selectionchange', handler);\n        return () => {\n          window.document.removeEventListener('selectionchange', handler);\n        };\n      }),\n    );\n\n    return {\n      [ObservablesEnum.ClickObservable]: clickObservable as Observable<ElementBasedTimestampedEvent<MouseEvent>>,\n      [ObservablesEnum.MutationObservable]: enrichedMutationObservable,\n      [ObservablesEnum.NavigateObservable]: enrichedNavigateObservable,\n      [ObservablesEnum.BrowserErrorObservable]: browserErrorObservables,\n      [ObservablesEnum.SelectionObservable]: selectionObservable,\n    };\n  };\n\n  const setup: BrowserEnrichmentPlugin['setup'] = async (config, amplitude) => {\n    /* istanbul ignore if */\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    // Create observables for events on the window\n    const allObservables = createObservables();\n\n    // Create subscriptions only for enabled features\n    if (rageClicksEnabled) {\n      const shouldTrackRageClick = createShouldTrackEvent(options, rageCssSelectors);\n      const rageClickSubscription = trackRageClicks({\n        allObservables,\n        amplitude,\n        shouldTrackRageClick,\n      });\n      subscriptions.push(rageClickSubscription);\n    }\n\n    if (deadClicksEnabled) {\n      const shouldTrackDeadClick = createShouldTrackEvent(options, deadCssSelectors);\n      const deadClickSubscription = trackDeadClick({\n        amplitude,\n        allObservables,\n        getEventProperties: (actionType, element) =>\n          dataExtractor.getEventProperties(actionType, element, dataAttributePrefix),\n        shouldTrackDeadClick,\n      });\n      subscriptions.push(deadClickSubscription);\n    }\n\n    if (isErrorClicksEnabled) {\n      const shouldTrackErrorClick = createShouldTrackEvent(options, errorCssSelectors);\n      const errorClickSubscription = trackErrorClicks({\n        amplitude,\n        allObservables,\n        shouldTrackErrorClick,\n      });\n      subscriptions.push(errorClickSubscription);\n    }\n\n    /* istanbul ignore next */\n    config?.loggerProvider?.log(`${name} has been successfully added.`);\n  };\n\n  const execute: BrowserEnrichmentPlugin['execute'] = async (event) => {\n    return event;\n  };\n\n  const teardown = async () => {\n    for (const subscription of subscriptions) {\n      subscription.unsubscribe();\n    }\n  };\n\n  return {\n    name,\n    type,\n    setup,\n    execute,\n    teardown,\n  };\n};\n"]}
{"version":3,"file":"track-error-click.js","sourceRoot":"","sources":["../../../src/autocapture/track-error-click.ts"],"names":[],"mappings":";AAEA,OAAO,EAEL,2BAA2B,EAC3B,WAAW,GAGZ,MAAM,YAAY,CAAC;AACpB,OAAO,EAAiB,KAAK,EAAE,MAAM,2BAA2B,CAAC;AACjE,OAAO,EAAE,qCAAqC,EAAE,MAAM,cAAc,CAAC;AAIrE,IAAM,mBAAmB,GAAG,IAAK,CAAC,CAAC,2CAA2C;AAE9E,MAAM,UAAU,gBAAgB,CAAC,EAQhC;QAPC,SAAS,eAAA,EACT,cAAc,oBAAA,EACd,qBAAqB,2BAAA;IAMb,IAAA,eAAe,GAA6B,cAAc,gBAA3C,EAAE,sBAAsB,GAAK,cAAc,uBAAnB,CAAoB;IAEnE,IAAM,uBAAuB,GAAG,eAAe,CAAC,MAAM,CAAC,UAAC,KAAK;QAC3D,OAAO,CACL,2BAA2B,CAAC,KAAK,CAAC;YAClC,qBAAqB,CAAC,OAAO,EAAE,KAAK,CAAC,sBAAsB,CAAC;YAC5D,KAAK,CAAC,KAAK,CAAC,MAAM,YAAY,OAAO;YACrC,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,oBAAoB,CAAC,KAAK,IAAI;YACzD,KAAK,CAAC,KAAK,CAAC,MAAM,KAAK,WAAW,CAAC,qBAAqB,CACzD,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,IAAI,eAAe,GAAyC,IAAI,CAAC;IACjE,IAAI,gBAAgB,GAAoD,IAAI,CAAC;IAE7E,IAAM,eAAe,GAAG;QACtB,IAAI,eAAe,KAAK,IAAI,EAAE;YAC5B,YAAY,CAAC,eAAe,CAAC,CAAC;YAC9B,eAAe,GAAG,IAAI,CAAC;SACxB;QACD,gBAAgB,GAAG,IAAI,CAAC;IAC1B,CAAC,CAAC;IAEF,OAAO,KAAK,CAAC,uBAAuB,EAAE,sBAAsB,CAAC,CAAC,SAAS,CAAC,UAAC,KAAwB;;QAC/F,IAAI,KAAK,CAAC,IAAI,KAAK,OAAO,EAAE;YAC1B,eAAe,EAAE,CAAC;YAClB,gBAAgB,GAAG,KAAiD,CAAC;YACrE,eAAe,GAAG,UAAU,CAAC,eAAe,EAAE,mBAAmB,CAAC,CAAC;YACnE,OAAO;SACR;QAED,IAAI,KAAK,CAAC,IAAI,KAAK,OAAO,IAAI,gBAAgB,EAAE;YAC9C,SAAS,CAAC,KAAK,CAAC,qCAAqC,wBAClD,kBAAkB,IAAG,KAAK,CAAC,KAAK,CAAC,IAAI,KACrC,qBAAqB,IAAG,KAAK,CAAC,KAAK,CAAC,OAAO,KAC3C,mBAAmB,IAAG,KAAK,CAAC,KAAK,CAAC,KAAK,KACvC,sBAAsB,IAAG,KAAK,CAAC,KAAK,CAAC,QAAQ,KAC7C,yBAAyB,IAAG,KAAK,CAAC,KAAK,CAAC,UAAU,KAClD,2BAA2B,IAAG,KAAK,CAAC,KAAK,CAAC,YAAY,OACpD,gBAAgB,CAAC,uBAAuB,EAC3C,CAAC;YACH,eAAe,EAAE,CAAC;SACnB;IACH,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["import { BrowserErrorEvent } from '../observables';\nimport { AllWindowObservables } from '../frustration-plugin';\nimport {\n  ElementBasedTimestampedEvent,\n  filterOutNonTrackableEvents,\n  MouseButton,\n  shouldTrackEvent,\n  TimestampedEvent,\n} from '../helpers';\nimport { BrowserClient, merge } from '@amplitude/analytics-core';\nimport { AMPLITUDE_ELEMENT_ERROR_CLICKED_EVENT } from '../constants';\n\ntype ClickOrErrorEvent = ElementBasedTimestampedEvent<MouseEvent> | TimestampedEvent<BrowserErrorEvent>;\n\nconst ERROR_CLICK_TIMEOUT = 2_000; // 2 seconds to wait for an error to happen\n\nexport function trackErrorClicks({\n  amplitude,\n  allObservables,\n  shouldTrackErrorClick,\n}: {\n  amplitude: BrowserClient;\n  allObservables: AllWindowObservables;\n  shouldTrackErrorClick: shouldTrackEvent;\n}) {\n  const { clickObservable, browserErrorObservable } = allObservables;\n\n  const filteredClickObservable = clickObservable.filter((click) => {\n    return (\n      filterOutNonTrackableEvents(click) &&\n      shouldTrackErrorClick('click', click.closestTrackedAncestor) &&\n      click.event.target instanceof Element &&\n      click.event.target.closest('a[target=\"_blank\"]') === null &&\n      click.event.button === MouseButton.LEFT_OR_TOUCH_CONTACT\n    );\n  });\n\n  let errorClickTimer: ReturnType<typeof setTimeout> | null = null;\n  let latestClickEvent: ElementBasedTimestampedEvent<MouseEvent> | null = null;\n\n  const clearClickTimer = () => {\n    if (errorClickTimer !== null) {\n      clearTimeout(errorClickTimer);\n      errorClickTimer = null;\n    }\n    latestClickEvent = null;\n  };\n\n  return merge(filteredClickObservable, browserErrorObservable).subscribe((event: ClickOrErrorEvent) => {\n    if (event.type === 'click') {\n      clearClickTimer();\n      latestClickEvent = event as ElementBasedTimestampedEvent<MouseEvent>;\n      errorClickTimer = setTimeout(clearClickTimer, ERROR_CLICK_TIMEOUT);\n      return;\n    }\n\n    if (event.type === 'error' && latestClickEvent) {\n      amplitude.track(AMPLITUDE_ELEMENT_ERROR_CLICKED_EVENT, {\n        ['[Amplitude] Kind']: event.event.kind,\n        ['[Amplitude] Message']: event.event.message,\n        ['[Amplitude] Stack']: event.event.stack,\n        ['[Amplitude] Filename']: event.event.filename,\n        ['[Amplitude] Line Number']: event.event.lineNumber,\n        ['[Amplitude] Column Number']: event.event.columnNumber,\n        ...latestClickEvent.targetElementProperties,\n      });\n      clearClickTimer();\n    }\n  });\n}\n"]}
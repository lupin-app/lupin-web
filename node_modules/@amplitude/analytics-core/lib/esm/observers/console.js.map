{"version":3,"file":"console.js","sourceRoot":"","sources":["../../../src/observers/console.ts"],"names":[],"mappings":"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","sourcesContent":["import { getGlobalScope } from '../global-scope';\n\ntype ConsoleLogLevel = keyof Console;\ntype Callback = (logLevel: ConsoleLogLevel, args: any[]) => void;\n\nconst globalScope = getGlobalScope();\n/* istanbul ignore next */\nconst originalConsole: any = globalScope?.console;\n\nlet handlers: { [key in ConsoleLogLevel]?: Array<Callback> } = {};\n\n// keeps reference to original console methods\nlet originalFn: { [key in ConsoleLogLevel]?: (...args: any[]) => void } = {};\n\nlet inConsoleOverride = false;\n\nfunction overrideConsole(logLevel: ConsoleLogLevel): boolean {\n  /* istanbul ignore if */\n  if (!originalConsole) {\n    return false;\n  }\n\n  // should not override if original console property is not a function\n  /* eslint-disable-next-line @typescript-eslint/no-unsafe-member-access */\n  if (typeof originalConsole[logLevel] !== 'function') {\n    return false;\n  }\n\n  // if console is already overridden, return true\n  if (originalFn[logLevel]) {\n    return true;\n  }\n\n  // override console method\n  const handler = function (...args: any[]) {\n    try {\n      if (handlers[logLevel] && !inConsoleOverride) {\n        // add a re-entrancy guard to prevent infinite recursion\n        inConsoleOverride = true;\n        const callbacks = handlers[logLevel];\n        if (callbacks) {\n          callbacks.forEach((callback) => {\n            try {\n              callback(logLevel, args);\n            } catch {\n              // do nothing\n            }\n          });\n        }\n      }\n    } catch {\n      // do nothing\n    }\n    inConsoleOverride = false;\n    return originalFn[logLevel]!.apply(originalConsole, args);\n  };\n  /* eslint-disable-next-line @typescript-eslint/no-unsafe-member-access */\n  originalFn[logLevel] = originalConsole[logLevel] as (...args: any[]) => void;\n  /* eslint-disable-next-line @typescript-eslint/no-unsafe-member-access */\n  originalConsole[logLevel] = handler;\n  return true;\n}\n\n/**\n * Observe a console log method (log, warn, error, etc.)\n * @param level - The console log level to observe\n * @param callback - The callback function to call when the console log level is observed\n */\nfunction addListener(level: ConsoleLogLevel, callback: Callback): Error | void {\n  const res = overrideConsole(level);\n\n  /* istanbul ignore if */\n  if (!res) {\n    return new Error('Console override failed');\n  }\n\n  if (handlers[level]) {\n    // using ! is safe because we know the key exists based on condition above\n    handlers[level]!.push(callback);\n  } else {\n    handlers[level] = [callback];\n  }\n}\n\n/**\n * Disconnect a callback function from a console log method\n * @param callback - The callback function to disconnect\n */\nfunction removeListener(callback: Callback) {\n  for (const callbacks of Object.values(handlers)) {\n    // iterate backwards to avoid index shifting\n    for (let i = callbacks.length - 1; i >= 0; i--) {\n      if (callbacks[i] === callback) {\n        callbacks.splice(i, 1);\n        break;\n      }\n    }\n  }\n}\n\n// this should only be used for testing\n// restoring console can break console overrides\nfunction _restoreConsole() {\n  for (const [key, originalHandler] of Object.entries(originalFn)) {\n    if (originalHandler) {\n      /* eslint-disable-next-line @typescript-eslint/no-unsafe-member-access */\n      originalConsole[key] = originalHandler;\n    }\n  }\n  originalFn = {};\n  handlers = {};\n}\n\nconst consoleObserver = {\n  addListener,\n  removeListener,\n  _restoreConsole,\n};\n\nexport { consoleObserver, ConsoleLogLevel };\n"]}